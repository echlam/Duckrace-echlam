<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DuckRace ‚Äì Sepoliav01</title>
  <script src="https://unpkg.com/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <style>
    :root { --bg:#0b0f14; --card:#121821; --text:#e6f0ff; --muted:#9bb0c9; --accent:#3aa0ff; --ok:#20c997; --warn:#f59f00; --bad:#fa5252; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    .title{font-size:28px;font-weight:800;margin-bottom:6px}
    .subtitle{color:var(--muted);margin-bottom:24px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 12px 0;font-size:18px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,button,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0e141b;color:var(--text)}
    textarea{min-height:82px;resize:vertical}
    button{cursor:pointer;font-weight:700;transition:.2s background,.2s transform}
    button.primary{background:var(--accent);border-color:transparent}
    button.primary:hover{transform:translateY(-1px)}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
    .log{white-space:pre-wrap;background:#0b1118;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.06);max-height:280px;overflow:auto}
    .list{margin:8px 0 0 0;padding-left:16px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08);margin-left:6px;font-size:12px;background:#0f1722}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">DuckRace ‚Äì Sepolia</div>
    <div class="subtitle">T·∫°o & ch·∫°y cu·ªôc ƒëua v·ªãt. B·∫£n demo d√πng pseudo-random ‚Üí kh√¥ng d√πng cho ti·ªÅn th·∫≠t.</div>

    <div class="grid">
      <!-- 1) Connect -->
      <div class="card">
        <h3>1) K·∫øt n·ªëi v√≠</h3>
        <div class="row">
          <button id="btnConnect" class="primary">K·∫øt n·ªëi MetaMask</button>
          <button id="btnCheck">Ki·ªÉm tra m·∫°ng</button>
        </div>
        <p class="muted">ƒê·ªãa ch·ªâ: <span id="account" class="mono">‚Äî</span></p>
        <p class="muted">M·∫°ng: <span id="network" class="mono">‚Äî</span></p>
      </div>

      <!-- 2) Create -->
      <div class="card">
        <h3>2) T·∫°o cu·ªôc ƒëua</h3>
        <label>Danh s√°ch t√™n v·ªãt (m·ªói d√≤ng m·ªôt t√™n)</label>
        <textarea id="duckNames" placeholder="Daisy&#10;Blue&#10;Quacker&#10;Flash"></textarea>
        <label>Th·ªùi l∆∞·ª£ng (gi√¢y)</label>
        <select id="duration">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="60">60</option>
        </select>
        <div class="row">
          <button id="btnCreate" class="primary">Create Race</button>
          <button id="btnGet">Get Race</button>
        </div>
        <p class="muted">Race ID hi·ªán t·∫°i: <span id="raceId" class="mono">‚Äî</span></p>
      </div>

      <!-- 3) Start/Finalize -->
      <div class="card">
        <h3>3) Ch·∫°y cu·ªôc ƒëua</h3>
        <label>Race ID</label>
        <input id="inputRaceId" placeholder="0" />
        <div class="row">
          <button id="btnStart" class="primary">Start Race</button>
          <button id="btnFinalize">Finalize Race</button>
        </div>
        <p class="muted">Sau khi Start, ƒë·ª£i ‚â• duration r·ªìi m·ªõi Finalize.</p>
      </div>

      <!-- 4) Ranking -->
      <div class="card">
        <h3>4) K·∫øt qu·∫£ x·∫øp h·∫°ng</h3>
        <div class="row">
          <button id="btnRankingNames" class="primary">Get Ranking (Names)</button>
          <button id="btnRankingIds">Get Ranking (IDs)</button>
        </div>
        <ul id="ranking" class="list"></ul>
      </div>

      <!-- 5) Find my races -->
      <div class="card">
        <h3>5) T√¨m c√°c race do v√≠ n√†y t·∫°o</h3>
        <div class="row">
          <button id="btnFindMyRaces" class="primary">Qu√©t RaceCreated c·ªßa t√¥i</button>
          <button id="btnFindByScan">Qu√©t tu·∫ßn t·ª± (fallback)</button>
        </div>
        <p class="muted">K·∫øt qu·∫£:</p>
        <ul id="myRaces" class="list"></ul>
      </div>
    </div>

    <div style="margin-top:16px" class="card">
      <h3>Logs</h3>
      <div id="log" class="log"></div>
      <p class="muted">Random: <span class="mono">block.prevrandao</span>. Mu·ªën c√¥ng b·∫±ng ‚Üí d√πng Chainlink VRF.</p>
    </div>
  </div>

<script>
(async () => {
  // ==== C·∫¨P NH·∫¨T ƒê·ªäA CH·ªà T·∫†I ƒê√ÇY ====
  const CONTRACT_ADDRESS = "0xd0322D2d264ba74651385cE019E4535077F27526"; // v1 c·ªßa b·∫°n
  // ===================================

  // ABI V1 (kh√¥ng c√≥ getMyRaces/lastRaceId)
  const ABI_V1 = [
    {"inputs":[{"internalType":"string[]","name":"duckNames","type":"string[]"},{"internalType":"uint256","name":"durationSeconds","type":"uint256"}],"name":"createRace","outputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"startRace","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"finalizeRace","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"getRace","outputs":[{"internalType":"address","name":"creator","type":"address"},{"internalType":"uint256","name":"duration","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint8","name":"status","type":"uint8"},{"internalType":"uint256","name":"duckCount","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"getRankingNames","outputs":[{"internalType":"string[]","name":"names","type":"string[]"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"getRankingIds","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"nextRaceId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    // events
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"raceId","type":"uint256"},{"indexed":true,"internalType":"address","name":"creator","type":"address"},{"indexed":false,"internalType":"uint256","name":"duration","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"duckCount","type":"uint256"}],"name":"RaceCreated","type":"event"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"raceId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"}],"name":"RaceStarted","type":"event"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"raceId","type":"uint256"},{"indexed":false,"internalType":"uint256[]","name":"ranking","type":"uint256[]"}],"name":"RaceFinished","type":"event"}
  ];

  // ABI V2 (c√≥ getMyRaces/lastRaceId)
  const ABI_V2 = [
    ...ABI_V1,
    {"inputs":[{"internalType":"address","name":"who","type":"address"}],"name":"getMyRaces","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"lastRaceId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
  ];

  const $ = id => document.getElementById(id);
  const log = msg => { const el=$("log"); el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.textContent; };

  let provider, signer, account, contract, ABI, IS_V2 = false;

  function getInjectedProvider() {
    if (window.ethereum) return window.ethereum;
    if (window.coinbaseWalletExtension) return window.coinbaseWalletExtension;
    return null;
  }

  async function ensureProvider(requestAccounts=false){
    const injected = getInjectedProvider();
    if (!injected || !injected.request){
      alert("Kh√¥ng th·∫•y v√≠ EVM. C√†i MetaMask ho·∫∑c m·ªü b·∫±ng in-app browser c·ªßa MetaMask.");
      throw new Error("No EIP-1193 provider");
    }
    if (requestAccounts){ await injected.request({method:"eth_requestAccounts"}); }
    provider = new ethers.BrowserProvider(injected);
    const net = await provider.getNetwork();
    signer = await provider.getSigner();
    account = await signer.getAddress();
    $("account").textContent = account;
    $("network").textContent = `${net.name} (chainId=${net.chainId})`;
    if (net.chainId !== 11155111n) log("‚ö†Ô∏è B·∫°n ch∆∞a ·ªü Sepolia.");
    injected.on?.("chainChanged", ()=>location.reload());
    injected.on?.("accountsChanged", ()=>location.reload());
    await selectABIAndBind(); // quan tr·ªçng: ch·ªçn ABI ƒë√∫ng phi√™n b·∫£n
    return {net, account};
  }

  async function selectABIAndBind(){
    // Ki·ªÉm tra c√≥ bytecode ·ªü ƒë·ªãa ch·ªâ kh√¥ng
    const code = await provider.getCode(CONTRACT_ADDRESS);
    if (code === "0x") {
      throw new Error("ƒê·ªãa ch·ªâ kh√¥ng c√≥ bytecode tr√™n Sepolia. Ki·ªÉm tra l·∫°i CONTRACT_ADDRESS ho·∫∑c m·∫°ng.");
    }

    // Th·ª≠ coi contract c√≥ h·ªó tr·ª£ h√†m v2 kh√¥ng
    // C√°ch ƒë∆°n gi·∫£n: th·ª≠ g·ªçi static getMyRaces(account)
    let v2 = false;
    try {
      const tmp = new ethers.Contract(CONTRACT_ADDRESS, ABI_V2, provider);
      await tmp.getMyRaces(account); // view call
      v2 = true;
    } catch(_) { v2 = false; }

    IS_V2 = v2;
    ABI = IS_V2 ? ABI_V2 : ABI_V1;
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    log(IS_V2 ? "üü¢ Ph√°t hi·ªán contract V2 (c√≥ getMyRaces/lastRaceId)." : "üü° Ph√°t hi·ªán contract V1 (kh√¥ng c√≥ getMyRaces/lastRaceId).");
    // ·∫®n/hi·ªán n√∫t UI theo phi√™n b·∫£n
    $("btnFindMyRaces").disabled = !IS_V2;
    $("btnFindMyRaces").title = IS_V2 ? "" : "Ch·ª©c nƒÉng ch·ªâ c√≥ ·ªü contract V2";
  }

  const statusMap = ["Created","Started","Finished"];
  const setCurrentId = id => { $("raceId").textContent=String(id); $("inputRaceId").value=String(id); };

  // ==== Buttons ====
  $("btnConnect").onclick = async ()=>{ try{ await ensureProvider(true); log("ƒê√£ k·∫øt n·ªëi v√≠."); }catch(e){ log(`L·ªói connect: ${e.message}`);} };
  $("btnCheck").onclick   = async ()=>{ try{ await ensureProvider(false);}catch(e){ log(`L·ªói check: ${e.message}`);} };

  $("btnCreate").onclick = async ()=>{
    try{
      await ensureProvider();
      const names=$("duckNames").value.trim().split("\n").map(s=>s.trim()).filter(Boolean);
      const duration=Number($("duration").value);
      if (names.length<2){ alert("C·∫ßn √≠t nh·∫•t 2 con v·ªãt"); return; }
      if (![10,20,30,60].includes(duration)){ alert("Duration ph·∫£i 10/20/30/60"); return; }

      const tx = await contract.createRace(names, duration);
      log(`TX: ${tx.hash}`);
      const rc = await tx.wait();
      const iface = new ethers.Interface(ABI);
      let foundId=null;
      for(const l of rc.logs){
        try{ const p=iface.parseLog(l); if(p?.name==="RaceCreated"){ foundId=p.args.raceId; break; } }catch(_){}
      }
      if (foundId!==null){ setCurrentId(foundId); log(`‚úÖ RaceCreated: raceId=${foundId}`); }
      else {
        // V2 c√≥ lastRaceId; V1 kh√¥ng c√≥ -> fallback nextRaceId-1
        try {
          if (IS_V2) {
            const last = await contract.lastRaceId();
            setCurrentId(last); log(`‚ÑπÔ∏è D√πng lastRaceId=${last}`);
          } else {
            const next = await contract.nextRaceId();
            const last = next - 1n;
            setCurrentId(last); log(`‚ÑπÔ∏è D√πng nextRaceId-1=${last}`);
          }
        } catch(err) {
          log(`Kh√¥ng l·∫•y ƒë∆∞·ª£c raceId fallback: ${err.message}`);
        }
      }
    }catch(e){ log(`L·ªói create: ${e.message}`); }
  };

  $("btnGet").onclick = async ()=>{
    try{
      await ensureProvider();
      const id = BigInt(($("inputRaceId").value||"0").trim());
      const r = await contract.getRace(id);
      log(`Race[${id}] creator=${r.creator}, duration=${r.duration}s, start=${r.startTime}, status=${statusMap[Number(r.status)]}, ducks=${r.duckCount}`);
      setCurrentId(id);
    }catch(e){ log(`L·ªói getRace: ${e.message}`); }
  };

  $("btnStart").onclick = async ()=>{
    try{
      await ensureProvider();
      const id=BigInt(($("inputRaceId").value||"0").trim());
      const tx=await contract.startRace(id); log(`Start TX: ${tx.hash}`);
      await tx.wait(); log("‚úÖ ƒê√£ start.");
    }catch(e){ log(`L·ªói start: ${e.message}`); }
  };

  $("btnFinalize").onclick = async ()=>{
    try{
      await ensureProvider();
      const id=BigInt(($("inputRaceId").value||"0").trim());
      const tx=await contract.finalizeRace(id); log(`Finalize TX: ${tx.hash}`);
      await tx.wait(); log("‚úÖ ƒê√£ finalize.");
    }catch(e){ log(`L·ªói finalize: ${e.message}`); }
  };

  $("btnRankingNames").onclick = async ()=>{
    try{
      await ensureProvider();
      const id=BigInt(($("inputRaceId").value||"0").trim());
      const names=await contract.getRankingNames(id);
      const ul=$("ranking"); ul.innerHTML=""; names.forEach((n,i)=>{ const li=document.createElement("li"); li.textContent=`#${i+1} ‚Äì ${n}`; ul.appendChild(li); });
      if (!names.length) log("Race ch∆∞a finish? H√£y finalize tr∆∞·ªõc.");
    }catch(e){ log(`L·ªói getRankingNames: ${e.message}`); }
  };

  $("btnRankingIds").onclick = async ()=>{
    try{
      await ensureProvider();
      const id=BigInt(($("inputRaceId").value||"0").trim());
      const ids=await contract.getRankingIds(id);
      const ul=$("ranking"); ul.innerHTML=""; ids.forEach((n,i)=>{ const li=document.createElement("li"); li.textContent=`#${i+1} ‚Äì duckId ${n}`; ul.appendChild(li); });
      if (!ids.length) log("Race ch∆∞a finish? H√£y finalize tr∆∞·ªõc.");
    }catch(e){ log(`L·ªói getRankingIds: ${e.message}`); }
  };

  // === Find my races: V2 d√πng getMyRaces; V1 fallback = logs ho·∫∑c scan tu·∫ßn t·ª± ===
  const statusLabel = s => ["Created","Started","Finished"][Number(s)]||"Unknown";
  const addMyRaceLine = (id, r)=>{
    const ul=$("myRaces");
    const li=document.createElement("li");
    li.innerHTML = `raceId=<span class="mono">${id}</span> ‚Äî status=${statusLabel(r.status)} ‚Äî ducks=${r.duckCount}`;
    li.style.cursor="pointer"; li.title="B·∫•m ƒë·ªÉ d√πng Race ID n√†y"; li.onclick=()=>setCurrentId(id);
    ul.appendChild(li);
  };

  $("btnFindMyRaces").onclick = async ()=>{
    try{
      $("myRaces").innerHTML="";
      const {account}=await ensureProvider();
      if (!IS_V2){ log("Ch·ª©c nƒÉng n√†y c·∫ßn contract V2."); return; }
      const ids = await contract.getMyRaces(account);
      if (!ids.length){ log("V√≠ n√†y ch∆∞a t·∫°o race n√†o."); return; }
      for (const id of ids){
        try{ const r=await contract.getRace(id); addMyRaceLine(id.toString(), r); }catch(e){ log(`getRace(${id}) l·ªói: ${e.message}`); }
      }
      log(`ƒê√£ l·∫•y ${ids.length} race b·∫±ng getMyRaces().`);
    }catch(e){ log(`L·ªói getMyRaces: ${e.message}`); }
  };

  $("btnFindByScan").onclick = async ()=>{
    try{
      $("myRaces").innerHTML="";
      const {account}=await ensureProvider();
      // V1/V2 ƒë·ªÅu c√≥ nextRaceId()
      const next = await contract.nextRaceId();
      const total = Number(next);
      if (total===0){ log("Ch∆∞a c√≥ race n√†o."); return; }
      log(`Qu√©t tu·∫ßn t·ª± 0..${total-1} (view call, kh√¥ng t·ªën gas)...`);
      const batch = 50;
      for (let i=0;i<total;i+=batch){
        const end = Math.min(total, i+batch);
        const calls = [];
        for (let j=i;j<end;j++){ calls.push(contract.getRace(j)); }
        const res = await Promise.allSettled(calls);
        for (let k=0;k<res.length;k++){
          const idx = i+k, rr = res[k];
          if (rr.status==="fulfilled"){
            const r = rr.value;
            if (r.creator?.toLowerCase()===account.toLowerCase()){ addMyRaceLine(idx, r); }
          }
        }
      }
      log("Qu√©t tu·∫ßn t·ª± xong.");
    }catch(e){ log(`L·ªói qu√©t tu·∫ßn t·ª±: ${e.message}`); }
  };

})();
</script>

</body>
</html>
