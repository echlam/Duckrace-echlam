<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DuckRace ‚Äì Track UI v05</title>
<script src="https://unpkg.com/ethers@6.13.2/dist/ethers.umd.min.js"></script>
<style>
  :root{--bg:#0b0f14;--panel:#111826;--line:#1b2433;--text:#eaf1ff;--muted:#9fb2cc;--accent:#3aa0ff;--ok:#22c55e;--warn:#f59e0b}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1024px;margin:28px auto;padding:0 16px}
  .top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;position:relative;z-index:2} /* n√¢ng z-index ƒë·ªÉ lu√¥n n·ªïi tr√™n */
  .badge{font-size:12px;color:var(--muted)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button,input,select,textarea{border:1px solid rgba(255,255,255,.1);background:#0d1420;color:var(--text);border-radius:12px;padding:10px 12px}
  button{cursor:pointer;font-weight:700}
  .primary{background:var(--accent);border-color:transparent}
  textarea{min-height:70px;width:100%;resize:vertical}

  .layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 14px;
    align-items: start;
  }
  @media(max-width: 1000px) {
    .layout { grid-template-columns: 1fr; }
  }

  .panel{display:grid;gap:10px}
  .mini{font-size:12px;color:var(--muted)}

  /* KHU V·ª∞C TRACK ‚Äî ƒë·∫©y xu·ªëng d∆∞·ªõi m·ªôt ch√∫t v√† h·∫° z-index ƒë·ªÉ kh√¥ng ƒë√® l√™n n√∫t */
  .track{
    position:relative;
    height:auto;
    min-height:340px;
    padding:16px;
    margin-top:8px;          /* th√™m kho·∫£ng c√°ch v·ªõi c√°c n√∫t ph√≠a tr√™n */
    z-index:1;               /* n·∫±m d∆∞·ªõi thanh n√∫t */
  }

  .finish{
    position:absolute;right:8px;top:8px;bottom:8px;width:4px;
    background:linear-gradient(180deg,var(--warn),#fbbf24);
    box-shadow:0 0 6px #f59e0b;pointer-events:none
  }
  .lanes{
    position:relative;border:1px solid rgba(255,255,255,.06);
    border-radius:14px;overflow:hidden;display:flex;flex-direction:column
  }
  .lane{
    position:relative;min-height:60px;border-bottom:1px dashed var(--line);
    display:flex;align-items:center
  }
  .lane:last-child{border-bottom:none}
  .name{position:absolute;left:10px;font-size:12px;color:var(--muted)}
  .duck{position:absolute;left:0;transform:translate(-50%,0);display:flex;align-items:center;gap:8px;transition:left .08s linear}
  .duck .em{font-size:32px}
  .duck .rank{display:none}
  .duck.finish .rank{display:inline-block;background:#0d1420;border:1px solid rgba(255,255,255,.1);padding:2px 8px;border-radius:999px;font-size:12px}

  .meter{height:6px;background:#0e1726;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#7dd3fc)}
  .logs{white-space:pre-wrap;max-height:160px;overflow:auto;background:#0b1118;border-radius:10px;border:1px solid rgba(255,255,255,.06);padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <button id="btnConnect" class="primary">K·∫øt n·ªëi MetaMask</button>
    <button id="btnStart">Start</button>
    <button id="btnFinalize">Finalize</button>
    <span class="badge">Account: <span id="acc">‚Äî</span></span>
    <span class="badge">Network: <span id="net">‚Äî</span></span>
    <span class="badge">Race ID: <b id="raceId">‚Äî</b></span>
    <span class="badge">Duration: <b id="dur">‚Äî</b>s</span>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">T·∫°o cu·ªôc ƒëua</div>
        <div class="mini" style="margin-bottom:6px">T√™n v·ªãt (m·ªói d√≤ng m·ªôt t√™n)</div>
        <textarea id="names" placeholder="Daisy&#10;Blue&#10;Quacker&#10;Flash"></textarea>
        <div class="row">
          <div style="flex:1">
            <div class="mini" style="margin-bottom:6px">Th·ªùi l∆∞·ª£ng</div>
            <select id="duration" style="width:100%">
              <option value="10">10 gi√¢y</option>
              <option value="20" selected>20 gi√¢y</option>
              <option value="30">30 gi√¢y</option>
              <option value="60">60 gi√¢y</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="btnCreate" class="primary">Create Race</button>
          </div>
        </div>
        <div class="mini" style="margin-top:8px">Sau khi Create th√†nh c√¥ng, b·∫•m <b>Start</b> ƒë·ªÉ v·ªãt ch·∫°y. Khi h·∫øt gi·ªù, b·∫•m <b>Finalize</b> ƒë·ªÉ nh·∫≠n th·ª© h·∫°ng on-chain.</div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Ti·∫øn tr√¨nh</div>
        <div class="meter"><div id="progress" class="bar"></div></div>
        <div class="mini" style="margin-top:6px">Logs</div>
        <div id="logs" class="logs"></div>
      </div>
    </div>

    <div class="card track">
      <div class="finish" title="ƒê√≠ch"></div>
      <div id="lanes" class="lanes"></div>
    </div>
  </div>
</div>

<script>
(() => {
  // ====== CONFIG ======
  const CONTRACT_ADDRESS = "0x5617b48F5688F92c151815aFfF295046183b982a"; // ƒë·ªïi n·∫øu b·∫°n d√πng ƒë·ªãa ch·ªâ kh√°c
  // ABI v1 (t∆∞∆°ng th√≠ch v2 ·ªü c√°c h√†m ch√≠nh)
  const ABI = [
    {"inputs":[{"internalType":"string[]","name":"duckNames","type":"string[]"},{"internalType":"uint256","name":"durationSeconds","type":"uint256"}],"name":"createRace","outputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"startRace","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"finalizeRace","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"getRace","outputs":[{"internalType":"address","name":"creator","type":"address"},{"internalType":"uint256","name":"duration","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint8","name":"status","type":"uint8"},{"internalType":"uint256","name":"duckCount","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"getRankingNames","outputs":[{"internalType":"string[]","name":"names","type":"string[]"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"raceId","type":"uint256"}],"name":"getRankingIds","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"nextRaceId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    // events (ƒë·ªÉ b·∫Øt raceId sau create)
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"raceId","type":"uint256"},{"indexed":true,"internalType":"address","name":"creator","type":"address"},{"indexed":false,"internalType":"uint256","name":"duration","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"duckCount","type":"uint256"}],"name":"RaceCreated","type":"event"}
  ];
  // =====================

  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ $("logs").textContent = `[${new Date().toLocaleTimeString()}] ${m}\n` + $("logs").textContent; };

  // web3
  let provider, signer, contract, account;
  // race state (UI)
  let currentRaceId = null;
  let currentDuration = 0;
  let startTs = 0;       // blockchain startTime (seconds)
  let animReq = null;
  let lanes = [];        // [{elDuck, nameEl, name, progress}...]

  // ===== web3 init =====
  function injected(){ return (window.ethereum || window.coinbaseWalletExtension || null); }

  async function ensureProvider(req=false){
    const eth = injected();
    if (!eth || !eth.request){ alert("Kh√¥ng th·∫•y MetaMask / v√≠ EVM."); throw new Error("No provider"); }
    if (req) await eth.request({method:"eth_requestAccounts"});
    provider = new ethers.BrowserProvider(eth);
    const net = await provider.getNetwork();
    signer = await provider.getSigner();
    account = await signer.getAddress();
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
    $("acc").textContent = account;
    $("net").textContent = `${net.name} (#${net.chainId})`;
    eth.on?.("chainChanged", ()=>location.reload());
    eth.on?.("accountsChanged", ()=>location.reload());
    if (net.chainId !== 11155111n) log("‚ö†Ô∏è B·∫°n ch∆∞a ·ªü Sepolia.");
  }

  // ===== UI: build track =====
  function buildTrack(names){
    const lanesWrap = $("lanes");
    lanesWrap.innerHTML = "";
    lanes = [];
    names.forEach((name, idx)=>{
      const lane = document.createElement("div");
      lane.className = "lane";
      const label = document.createElement("div");
      label.className = "name";
      label.textContent = name;
      const duck = document.createElement("div");
      duck.className = "duck";
      duck.style.top = "50%";
      duck.style.left = "0%";
      duck.style.transform = "translate(-50%,-50%)";
      duck.innerHTML = `<span class="em">ü¶Ü</span><span class="rank"></span>`;
      lane.appendChild(label);
      lane.appendChild(duck);
      lanesWrap.appendChild(lane);
      lanes.push({elDuck: duck, nameEl: label, name, progress: 0});
    });
  }

  function setProgress(p){ $("progress").style.width = `${Math.max(0, Math.min(100, p))}%`; }

  // animation loop during START
  function animateRace(){
    if (!startTs || !currentDuration || lanes.length===0){ return; }
    const nowSec = Math.floor(Date.now()/1000);
    const elapsed = Math.max(0, nowSec - startTs);
    const pct = Math.min(1, elapsed / currentDuration);
    setProgress(pct*100);

    // simple easing: m·ªói v·ªãt c√≥ seed t·ª´ t√™n ƒë·ªÉ dao ƒë·ªông nh·∫π, nh∆∞ng kh√¥ng quy·∫øt ƒë·ªãnh th·ª© h·∫°ng
    lanes.forEach((L, i)=>{
      // dao ƒë·ªông nh·ªè ƒë·ªÉ nh√¨n sinh ƒë·ªông
      const wobble = Math.sin((Date.now()/200)+i)*0.01;
      L.progress = Math.max(L.progress, Math.min(1, pct + wobble));
      const leftPct = 6 + L.progress * 88; // 6% ƒë·∫øn 94% (ƒë√≠ch)
      L.elDuck.style.left = `${leftPct}%`;
    });

    if (pct < 1){
      animReq = requestAnimationFrame(animateRace);
    } else {
      cancelAnimationFrame(animReq); animReq=null;
      log("‚è± H·∫øt th·ªùi gian. B·∫•m Finalize ƒë·ªÉ nh·∫≠n th·ª© h·∫°ng on-chain.");
    }
  }

  // snap ducks to final ranking
  function applyRanking(namesRanking){
    // Map name -> rank
    const rankMap = new Map();
    namesRanking.forEach((n, idx)=> rankMap.set(n, idx+1));
    // s·∫Øp x·∫øp lanes theo rank (n·∫øu c√≥)
    lanes.sort((a,b)=>{
      const ra = rankMap.get(a.name) ?? 9999;
      const rb = rankMap.get(b.name) ?? 9999;
      return ra - rb;
    });

    // rebuild lanes order + g·∫Øn huy ch∆∞∆°ng
    const lanesWrap = $("lanes");
    const frag = document.createDocumentFragment();
    lanes.forEach((L, i)=>{
      const lane = document.createElement("div");
      lane.className = "lane";
      const label = document.createElement("div");
      label.className = "name";
      label.textContent = L.name;
      const duck = L.elDuck;
      duck.classList.add("finish");
      const rank = rankMap.get(L.name);
      const badge = duck.querySelector(".rank");
      badge.textContent = rank ? (rank===1?"ü•á #1":rank===2?"ü•à #2":rank===3?"ü•â #3":`#${rank}`) : "‚Äî";
      duck.style.left = "94%";
      duck.style.transform = "translate(-50%,-50%)";
      lane.appendChild(label);
      lane.appendChild(duck);
      frag.appendChild(lane);
    });
    lanesWrap.innerHTML = "";
    lanesWrap.appendChild(frag);
    setProgress(100);
  }

  // ===== handlers =====
  $("btnConnect").onclick = async ()=>{
    try { await ensureProvider(true); log("ƒê√£ k·∫øt n·ªëi v√≠."); }
    catch(e){ log(`Connect error: ${e.message}`); }
  };

  $("btnCreate").onclick = async ()=>{
    try{
      await ensureProvider();
      const raw = $("names").value.trim();
      const names = raw.split("\n").map(s=>s.trim()).filter(Boolean);
      const dur = Number($("duration").value);
      if (names.length < 2){ alert("C·∫ßn √≠t nh·∫•t 2 con v·ªãt"); return; }
      if (![10,20,30,60].includes(dur)){ alert("Th·ªùi l∆∞·ª£ng ch·ªâ 10/20/30/60"); return; }

      // g·ªçi create
      const tx = await contract.createRace(names, dur);
      log(`Create TX: ${tx.hash}`);
      const rc = await tx.wait();

      // l·∫•y raceId t·ª´ event
      let raceId = null;
      const iface = new ethers.Interface(ABI);
      for (const l of rc.logs){
        try {
          const p = iface.parseLog(l);
          if (p?.name === "RaceCreated"){ raceId = p.args.raceId; break; }
        } catch(_) {}
      }
      if (raceId === null){
        const next = await contract.nextRaceId();
        raceId = (next - 1n);
        log(`(fallback) raceId = ${raceId}`);
      }

      currentRaceId = raceId;
      currentDuration = dur;
      startTs = 0;
      $("raceId").textContent = raceId.toString();
      $("dur").textContent = String(dur);

      // d·ª±ng lane & reset thanh ti·∫øn tr√¨nh
      buildTrack(names);
      setProgress(0);
      log(`‚úÖ Created race #${raceId} v·ªõi ${names.length} v·ªãt, duration=${dur}s`);
    }catch(e){ log(`Create error: ${e.message}`); }
  };

  $("btnStart").onclick = async ()=>{
    try{
      if (currentRaceId===null){ alert("Ch∆∞a c√≥ race. H√£y Create tr∆∞·ªõc."); return; }
      await ensureProvider();
      const tx = await contract.startRace(currentRaceId);
      log(`Start TX: ${tx.hash}`);
      await tx.wait();
      // ƒë·ªçc l·∫°i info ƒë·ªÉ l·∫•y startTime & duration th·ª±c
      const r = await contract.getRace(currentRaceId);
      startTs = Number(r.startTime);
      currentDuration = Number(r.duration);
      $("dur").textContent = String(currentDuration);

      // ch·∫°y animation theo th·ªùi gian on-chain
      if (animReq) cancelAnimationFrame(animReq);
      animReq = requestAnimationFrame(animateRace);
      log(`üèÅ Race #${currentRaceId} b·∫Øt ƒë·∫ßu. Ch·ªù ~${currentDuration}s r·ªìi Finalize.`);
    }catch(e){ log(`Start error: ${e.message}`); }
  };

  $("btnFinalize").onclick = async ()=>{
    try{
      if (currentRaceId===null){ alert("Ch∆∞a c√≥ race."); return; }
      await ensureProvider();
      const tx = await contract.finalizeRace(currentRaceId);
      log(`Finalize TX: ${tx.hash}`);
      await tx.wait();

      // l·∫•y th·ª© h·∫°ng theo t√™n v√† ‚Äúsnap‚Äù v·ªÅ ƒë√≠ch
      const rankNames = await contract.getRankingNames(currentRaceId);
      applyRanking(rankNames);
      log(`üèÜ K·∫øt qu·∫£: ${rankNames.map((n,i)=>`#${i+1} ${n}`).join(" | ")}`);
    }catch(e){ log(`Finalize error: ${e.message}`); }
  };

})();
</script>
</body>
</html>
